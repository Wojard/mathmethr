---
title       : Дисперсионный анализ, часть 1
subtitle: "Математические методы в зоологии с использованием R"
author: "Марина Варфоломеева"
output:
  beamer_presentation:
    colortheme: seagull
    highlight: tango
    fonttheme: structurebold
    includes:
      in_header: ./includes/header.tex
    pandoc_args:
    - --latex-engine=xelatex
    - -V fontsize=10pt
    - -V lang=russian
    slide_level: 2
    theme: CambridgeUS
    toc: yes
---

```{r setup, include = FALSE, cache = FALSE, purl = FALSE}
options(width = 70, scipen = 6)
library(knitr)
opts_chunk$set(fig.show='hold', size='footnotesize', comment="#", warning=FALSE, message=FALSE, dev='cairo_pdf', fig.height=2.5, fig.width=7.7)
```

## Знакомимся дисперсионным анализом

### Вы сможете

- Объяснить, в чем опасность множественных сравнений, и как с ними можно бороться
- Рассказать, как в дисперсионном анализе моделируются значения зависимой переменной
- Перечислить и проверить условия применимости дисперсионного анализа
- Интерпретировать и описать результаты, записанные в таблице дисперсионного анализа
- Провести множественные попарные сравнения при помощи post hoc теста Тьюки, представить и описать их результаты

# Множественные сравнения

## Пример: сон у млекопитающих

- `TotalSleep` - общая продолжительность сна. В нашем анализе это будет зависимая переменная
- `Danger`  - уровень опасности среды для вида, пять градаций (1 - 5)

\vskip0pt plus 1filll
\tiny Данные: Allison, Cicchetti (1976), электронная версия [Statlib database](http://lib.stat.cmu.edu)


## Скачиваем данные с сайта

Не забудьте войти в вашу директорию для матметодов при помощи `setwd()`

```{r eval=FALSE}
library(downloader)

# в рабочем каталоге создаем суб-директорию для данных
if(!dir.exists("data")) dir.create("data")

# скачиваем файл в xlsx, либо в текстовом формате
if (!file.exists("data/sleep.xlsx")) {
  download(
    url = "https://varmara.github.io/mathmethr/data/sleep.xlsx",
    destfile = "data/sleep.xlsx")
}

if (!file.exists("data/sleep.csv")) {
  download(
    url = "https://varmara.github.io/mathmethr/data/sleep.xls",
    destfile = "data/sleep.csv")
}
```


## Читаем данные из файла одним из способов

### Чтение из xlsx
```{r}
library(readxl)
sleep <- read_excel(path = "data/sleep.xlsx", sheet = 1)
```

### Чтение из csv

```{r}
sleep <- read.table("data/sleep.csv", header = TRUE, sep = "\t")
```

## Все ли правильно открылось?

```{r}
str(sleep) # Структура данных
head(sleep, 2)     # Первые несколько строк файла
```


```{r}
# Сделаем sleep$Danger фактором
sleep$Danger <- factor(sleep$Danger, levels = 1:5, labels = c("очень низкий", "низкий", "средний", "высокий", "очень высокий"))
```


## Знакомимся с данными

Есть ли пропущенные значения?

```{r}
sapply(sleep, function(x)sum(is.na(x)))
```

К счастью про уровень опасности (`Danger`) информация есть для всех объектов.

Но есть пропущенные значения продолжительности сна (`TotalSleep`). 

## Каков объем выборки?

В одной из переменных, которые нам интересны, есть пропущенные значения. Это нужно учесть при рассчете объема выборки.

Удалим из датафрейма `sleep` строки, где `TotalSleep` принимает значение `NA`.

```{r}
flt <- ! is.na(sleep$TotalSleep)
sl <- sleep[flt, ]
```

\small
Дальше будем работать с датафреймом `sl`. В нем нет пропущенных значений в интересующих нас переменных

```{r}
nrow(sl)
```

Каков объем выборки в каждой группе?

```{r}
table(sl$Danger)
```


## Задание

Постройте график зависимости общей продолжительности сна (`TotalSleep`) от уровня опасности среды (`Danger`). Используйте `geom_boxplot`.

Раскрасьте график в зависимости от уровня опасности среды (используйте эстетики `fill` или `colour`)

Придумайте, каким образом посчитать, в какой группе животных общая продолжительность сна больше?

\vskip0pt plus 1filll

### Дополнительное задание:

Попробуйте сменить палитру раскраски, используя `scale_colour_brewer` (варианты можно посмотреть в справке в подразделе примеров или в интернете [Colors (ggplot2): раздел RColorBrewer palette chart](http://www.cookbook-r.com/Graphs/Colors_%28ggplot2%29/) )

## Решение

```{r}
library(ggplot2) 
theme_set(theme_bw())

gg_sl <- ggplot(data = sl, aes(x = Danger, y = TotalSleep, colour = Danger)) + 
  labs(x = "Уровень опасности", y = "Продолжительность сна") + 
  scale_colour_brewer("Уровень опасности", palette = "Dark2")
gg_sl + geom_boxplot()
```

## Множественные сравнения

Мы могли бы сравнить среднюю продолжительность сна в разных группах при помощи t-критерия.

- 5 групп
- 10 сравнений

Если для каждого сравнения вероятность ошибки первого рода будет $\alpha_{per\ comparison} = 0.05$, то для группы --- ?

\pause

$\alpha_{family\ wise} = 0.05 * 10$

В половине случаев мы рискуем найти различия там где их нет!!!

## Поправка Бонферрони

Если нужно много сравнений, можно снизить $\alpha _{per\ comparison}$

$$\alpha _{per\ comparison} = \frac{\alpha _{family\ wise}}{n}$$

\vfill
\pause

Например, если хотим зафиксировать $\alpha _{family\ wise} = 0.05$

С поправкой Бонферрони $\alpha _{per\ comparison} = 0.05 / 10 = 0.005$

Очень жесткий критерий!

\vskip0pt plus 1filll


# Дисперсионный анализ

## Модель дисперсионного анализа

<div class="columns-2">

$$y _{ij} = \mu + a _i + \varepsilon _{ij}$$

Из чего складываются средние значения в группах по фактору? 

Группа | Общее среднее | Эффект | <small>Случайная изменчивость</small>
----- | ----- | ----- | -----
очень низкий | $$\mu$$ | $$a _1$$ | $$\varepsilon _{1j}$$
низкий | $$\mu$$ | $$a _2$$ | $$\varepsilon _{2j}$$
... | ... | ... | ...
очень высокий | $$\mu$$ | $$a _5$$ | $$\varepsilon _{5j}$$


```{r echo = FALSE}
sl[, c("Danger", "TotalSleep")]
```


## Структура общей изменчивости

Общая изменчивость (SSt) = Факторная (SSx) + Случайная (SSe)

```{r echo = FALSE, warning=FALSE, fig.width = 10.5, fig.height=5}
lims <- range(sl$TotalSleep) + c(-1, 1)
yannot <- lims[1] + 0.5
pos <- position_jitter(width = 0.2)
gmean <- mean(sl$TotalSleep, na.rm = TRUE)

gg_sl <- gg_sl + theme(legend.position = "none", axis.text.x = element_text(angle = 30, vjust = .8, hjust = .8)) + ylim(lims[1], lims[2])

# # Общая изменчивость (отклонения от общего среднего)
gg_sl_total <- gg_sl + 
  geom_jitter(position = pos) +
  geom_hline(yintercept = gmean, linetype = "dashed") + 
  ggtitle("Общая изменчивость\n(отклонения от общего среднего)") +
  annotate("text", label = "Общее\nсреднее", 
           x = 0,  y = gmean, hjust = -0.1, size = 4) + 
  annotate("text", label = "SS[t] == sum((bar(y) - y[i]))^2", parse = TRUE, x = 0,  y = yannot, hjust = -0.1, size = 6) 

library(plyr)
# Межгрупповая изменчивость (связанная с фактором)
gg_sl_factor <- gg_sl + 
  geom_hline(aes(yintercept = gmean), linetype = "dashed") + 
  stat_summary(fun.y = "mean", geom = "point", size = 20, shape = 45) + 
  ggtitle("Факторная изменчивость\n(межгрупповая)")+
    annotate("text", label = "SS[x] == sum((bar(y) - hat(y)[i]))^2", parse = TRUE, x = 0,  y = yannot, hjust = -0.1, size = 6)

# Внутригрупповая изменчивость (случайная)
gg_sl_error <- gg_sl + 
  geom_jitter(position = position_jitter(width = 0.3)) +
  stat_summary(fun.y = "mean", geom = "point", size = 20, shape = 45, colour = "black") + 
  ggtitle("Случайная изменчивость\n(внутригрупповая)")+
    annotate("text", label = "SS[e] == sum(sum((y [i] - hat(y)[i])))^2", parse = TRUE, x = 0,  y = yannot, hjust = -0.1, size = 6)

library(gridExtra)
grid.arrange(gg_sl_total, gg_sl_factor, gg_sl_error, ncol = 3, widths = c(0.38, 0.31, 0.31))
```

Если выборки из одной совокупности, то
Факторная изменчивость = Случайная изменчивость

## Таблица дисперсионного анализа 

Источник изменчивости  |  Суммы квадратов отклонений,<br /><br /> SS   |   Число степеней свободы,<br /><br /> df   | Средний квадрат отклонений<br />(дисперсия),<br /> MS | <br /><br /><br /> F  
---------------------- | --------- | ------ | ------------------- | -----
Название фактора | $$SS _x = \sum{(\bar y - \hat y _i)^2}$$ | $$df _x = a - 1$$ | $$MS _x = \frac{SS _x}{df _x}$$ | $$F _{df _r, df _e} = \frac{MS _r}{MS _e}$$
Случайная | $$SS _e = \sum{(y _i - \hat y _i)^2}$$ | $$df _e = N - a$$ | $$MS _e = \frac{SS _e}{df _e}$$ | 
Общая | $$SS _t = \sum {(\bar y - y _i)^2}$$ | $$df _t = N - 1$$ | 


Гипотезы:

$H _0: MS _x = MS _e$, $H _A: MS _x ≠ MS _e$


## Дисперсионный анализ в R

Используем Anova из пакета car, хотя есть и другие функции. Зачем? Когда факторов будет больше одного, эта функция сможет правильно оценить достоверность каждого из них независимо от других.

Anova(результат_функции_lm) - дисперсионный анализ

```{r}
library(car)
mod <- lm(TotalSleep ~ Danger, data=sl)
sl_anova <- Anova(mod)
sl_anova
```

```{r,echo=FALSE}
result <- sl_anova
dfs <- paste0(result$Df, collapse= ",")
fval <- round(result$'F value'[1], 2)
sign <- ifelse(result$'Pr(>F)'[1] <= 0.01, "$p < 0.01$", ifelse(result$'Pr(>F)'[1] <= 0.05, "$p < 0.05$", ""))
```

>- Общая продолжительность сна различается у видов животных, которые в разной степени подвержены опасностям в течение жизни ($F _{`r dfs`} = `r fval`$, `r sign`).


## Вопрос: 

Назовите условия применимости дисперсионного анализа

>- Подсказка: дисперсионный анализ - линейная модель, как и регрессия

## Ответ:

Условия примененимости дисперсионного анализа:

- Случайность и независимость групп и наблюдений внутри групп
- Нормальное распределение остатков
- Гомогенность дисперсий остатков

Другие ограничения:

- Лучше работает, если размеры групп примерно одинаковы (т.наз. сбалансированный дисперсионный комплекс)
- Устойчив к отклонениям от нормального распределения (при равных объемах групп или при больших выборках)

## Задание: Проверьте условия применимости

Проверьте условия применимости дисперсионного анализа используя графики остатков

## Решение

## 1. Данные для проверки условий применимости на графиках остатков

```{r}
# Данные для анализа остатков
sl_diag <- fortify(mod)
head(sl_diag)
```

## 2. Выбросы, гомогенность дисперсий

```{r fig.width=10, tidy=FALSE}
gg_res <- ggplot(sl_diag, aes(x = .fitted, y = .stdresid)) + 
  geom_hline(yintercept = 0)
gg_1 <- gg_res + geom_point(aes(size = .cooksd))
gg_2 <- gg_res + geom_boxplot(aes(x = Danger))
library(gridExtra)
grid.arrange(gg_1, gg_2, ncol = 2)
```

>- Остатки в пределах двух стандартных отклонений, расстояния Кука маленькие - можно продолжать.
- Подозрительно маленькая дисперсия продолжительности сна в группе с очень высоким уровнем опасности.

## 3. Нормальность распределения

```{r}
ggplot(sl_diag) + geom_point(stat = "qq", aes(sample = .stdresid)) + 
  geom_abline(intercept = 0, slope = sd(sl_diag$.stdresid))
```

>- Распределение практически нормальное

## Немного более удобный квантильный график для проверки нормальности распределения

qqPlot() из пакета car
```{r, echo=FALSE}
set.seed(93)
```
```{r, fig.height=4}
qqPlot(mod)
```

>- Нет отклонений от нормального распределения

# Post hoc тесты

## Post-hoc тесты

Дисперсионный анализ показывает, есть ли влияние фактора (= различаются ли средние значения зависимой переменной между группами)

Пост-хок тесты показывают, какие именно из возможных пар средних значений различаются.

## Свойства post-hoc тестов для попарных сравнений средних

- Применяются, если влияние фактора значимо
- Делают поправку для снижения вероятности ошибки I рода $\alpha$, (но не слишком, чтобы не
снизилась мощность, чтобы не возросла $\beta$)
  - Учитывают величину различий между средними
  - Учитывают количество сравниваемых пар
- Различаются по степени консервативности (Тьюки - разумный компромисс) 
- Работают лучше при равных объемах групп, при гомогенности дисперсий

## Пост-хок тест Тьюки в R

- `glht()` - "general linear hypotheses testing"
- `linfct` - аргумент, задающий гипотезу для тестирования

- `mcp()` - функция, чтобы задавать множественные сравнения (обычные пост-хоки)
- `Danger` = "Tukey" - тест Тьюки по фактору `Danger`

```{r, warning=FALSE, message=FALSE}
library(multcomp)
sl_pht <- glht(mod, linfct = mcp(Danger = "Tukey"))
```

## Результаты попарных сравнений (тест Тьюки)


```{r, R.options=list(width = 80)}
summary(sl_pht)
```

## Описываем результаты пост-хок теста

- Продолжительность сна у видов, подвергающихся очень высокому уровню опасности в течение жизни, значительно меньше, чем у тех, кто живет при среднем, низком и очень низком уровне опасности (тест Тьюки, $p < 0.05$). 

# Графическое представление результатов пост-хок теста

## Посчитаем описательную статистику по группам

```{r, tidy=FALSE, message=FALSE}
library(dplyr) # есть удобные функции для описания данных
sl_summary <- sl %>% # берем датафрейм sl
  group_by(Danger) %>% # делим на группы по Danger
  # по каждой группе считаем разное
  summarise(
    .n = sum(!is.na(TotalSleep)),
    .mean = mean(TotalSleep, na.rm = TRUE),
    .sd = sd(TotalSleep, na.rm = TRUE),
    .upper_cl = .mean + 1.98*.sd,
    .lower_cl = .mean - 1.98*.sd)
sl_summary
```

## Этот график можно использовать для представления результатов

```{r tidy=FALSE}
gg_means <- ggplot(sl_summary, aes(x = Danger, y = .mean)) + 
  geom_bar(stat = "identity", fill = "turquoise3", colour = "black", width = 0.5) + 
  geom_errorbar(aes(ymin = .lower_cl, ymax = .upper_cl), width = 0.1) +
  labs(x = "Обработка", y = "Вес, г") +
  geom_text(aes(label = c("A", "A", "A", "AB", "B"), vjust = -0.3, hjust = 1.5), size = 6)
gg_means
```

>- Достоверно различающиеся по пост-хок тесту группы обозначим разными буквами.

## Можно "опустить" прямоугольники на ось х

```{r fig.height = 4, tidy=FALSE}
upperlimit <- max(sl_summary$.upper_cl + 1)
gg_means +
  scale_y_continuous(expand = c(0,0),
    limit = c(0, upperlimit))
```

## Сохраняем таблицу дисперсионного анализа в файл

```{r eval = FALSE, tidy=FALSE}
# 1) в csv
write.csv(sl_anova, file = "medley_res.csv")

# 2) в xls или xlsx с помощью XLConnect
library(XLConnect)
writeWorksheetToFile(data = sl_anova, file = "medley_res.xls", 
                     sheet = "anova_table")

# или

# 3) отправляем в буфер обмена (только Windows) для вставки в Word-Excel
write.table(file = "clipboard", x = sl_anova, sep = "\t")
```


## Take home messages

>- При множественных попарных сравнениях увеличивается вероятность ошибки первого рода. Поправка Бонферрони - способ точно рассчитать, насколько нужно снизить уровень значимости для каждого из сравнений
- При помощи дисперсионного анализа можно проверить гипотезу о равенстве средних значений
- Условия применимости (должны выполняться, чтобы тестировать гипотезы)
  - Случайность и независимость групп и наблюдений внутри групп
  - Нормальное распределение
  - Гомогенность дисперсий
- Post hoc тесты - это попарные сравнения после дисперсионного анализа, которые позволяют сказать, какие именно средние различаются


## Дополнительные ресурсы

- Quinn, Keough, 2002, pp. 173-207
- Logan, 2010, pp. 254 - 282
- [Open Intro to Statistics](http://www.openintro.org/stat/), pp.236-246 
- Sokal, Rohlf, 1995, pp. 179-260
- Zar, 2010, pp. 189-207
